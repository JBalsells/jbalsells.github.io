<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Física del Rescate — Factor de Caída</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto:wght@300;400;500;700&display=swap">
  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/font-awesome/css/all.min.css" rel="stylesheet">
  <link href="../css/main.css" rel="stylesheet">
  <style>
    .sim-content *, .sim-content *::before, .sim-content *::after { box-sizing: border-box; margin: 0; padding: 0; }


    h1 {
      font-size: 1.45rem;
      color: #00BCD4;
      text-align: center;
      margin-bottom: 10px;
      letter-spacing: 0.4px;
      font-weight: 700;
    }

    .main-layout {
      display: flex;
      gap: 14px;
      align-items: flex-start;
      width: 100%;
      max-width: 1200px;
    }

    canvas {
      display: block;
      border-radius: 8px;
      border: 1px solid #143045;
      background: #061520;
      flex-shrink: 0;
    }

    /* ── Right panel ── */
    .right-panel {
      flex: 1;
      background: #0a1e2f;
      border: 1px solid #00BCD4;
      border-radius: 8px;
      padding: 14px 16px;
      min-width: 0;
    }

    /* ── Scenario buttons ── */
    .scenario-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .btn-scenario {
      flex: 1;
      min-width: 80px;
      padding: 8px 6px;
      border: 1px solid #143045;
      border-radius: 6px;
      background: #1a1a2e;
      color: #ECEFF1;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s, border-color 0.18s;
      text-align: center;
    }
    .btn-scenario:hover { background: #22223a; border-color: #00BCD4; }
    .btn-scenario.active { background: #0d3345; border-color: #00BCD4; color: #00BCD4; }

    /* ── Action buttons ── */
    .action-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .btn-action {
      padding: 9px 14px;
      border-radius: 6px;
      border: none;
      font-size: 0.86rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn-action:hover { opacity: 0.85; }
    .btn-fall   { background: #F44336; color: #fff; }
    .btn-reset  { background: #143045; color: #ECEFF1; border: 1px solid #444; }
    .btn-slow   { background: #2196F3; color: #fff; }
    .btn-slow.active { background: #0d47a1; }
    .btn-pause  { background: #FFC107; color: #1a1a1a; }
    .btn-pause.active { background: #f57f17; }

    /* ── Info section ── */
    .info-label {
      font-size: 0.78rem;
      color: #78909C;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      margin-bottom: 2px;
      margin-top: 10px;
    }
    .info-value {
      font-size: 0.93rem;
      color: #ECEFF1;
      font-variant-numeric: tabular-nums;
    }
    .info-value.primary   { color: #00BCD4; font-weight: 700; font-size: 1rem; }
    .info-value.accent    { color: #4CAF50; }
    .info-value.warning   { color: #FFC107; }
    .info-value.danger    { color: #F44336; }
    .info-value.info      { color: #2196F3; }

    .divider {
      border: none;
      border-top: 1px solid #143045;
      margin: 10px 0;
    }

    /* ── Semaforo ── */
    .semaforo-row {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
    }
    .semaforo {
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #191928;
      border: 1px solid #143045;
      border-radius: 8px;
      padding: 8px 10px;
    }
    .light {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      transition: background 0.25s;
    }
    .light.red-off    { background: #3d1010; }
    .light.yellow-off { background: #3d2f05; }
    .light.green-off  { background: #0a1f0a; }
    .light.red-on     { background: #F44336; box-shadow: 0 0 8px #F44336; }
    .light.yellow-on  { background: #FFC107; box-shadow: 0 0 8px #FFC107; }
    .light.green-on   { background: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
    .semaforo-label {
      font-size: 0.9rem;
      font-weight: 700;
    }

    /* ── Force bars ── */
    .bar-container {
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .bar-bg {
      position: relative;
      background: #1a1a2e;
      border-radius: 4px;
      height: 24px;
      margin-bottom: 5px;
      overflow: visible;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
      min-width: 0;
    }
    .bar-text {
      position: absolute;
      left: 8px;
      top: 4px;
      font-size: 0.78rem;
      color: #ECEFF1;
      pointer-events: none;
      white-space: nowrap;
    }
    .bar-marker {
      position: absolute;
      top: -3px;
      width: 2px;
      height: 30px;
      pointer-events: none;
    }
    .bar-marker-label {
      position: absolute;
      top: -16px;
      font-size: 0.65rem;
      white-space: nowrap;
      transform: translateX(-50%);
    }

    /* ── Comparison table ── */
    .comp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 6px;
    }
    .comp-table th {
      color: #78909C;
      font-weight: 600;
      text-align: left;
      padding: 3px 6px;
      border-bottom: 1px solid #143045;
    }
    .comp-table td {
      padding: 3px 6px;
      font-variant-numeric: tabular-nums;
    }
    .comp-table tr.active-row td { color: #FFC107; font-weight: 700; }
    .comp-table tr:not(.active-row) td { color: #b0bec5; }

    /* ── Narrative bar ── */
    .narrative {
      margin-top: 10px;
      padding: 7px 12px;
      border-radius: 6px;
      background: #10101f;
      border: 1px solid #143045;
      font-size: 0.88rem;
      font-weight: 600;
      text-align: center;
      min-height: 34px;
    }

    /* ── Controls bar ── */
    .controls-bar {
      width: 100%;
      max-width: 1200px;
      margin-top: 10px;
      background: #0a1e2f;
      border: 1px solid #143045;
      border-radius: 8px;
      padding: 9px 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 18px;
      font-size: 0.78rem;
      color: #b0b8cc;
    }
    .ctrl-item { display: flex; align-items: center; gap: 5px; }
    .kbd {
      background: #1a1a2e;
      border: 1px solid #3a3a5e;
      border-radius: 4px;
      padding: 1px 6px;
      font-size: 0.74rem;
      color: #00BCD4;
      font-family: monospace;
      font-weight: 700;
    }

    /* ── Slow-motion badge ── */
    .slow-badge {
      display: none;
      background: #2196F3;
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
      border-radius: 4px;
      padding: 2px 8px;
      margin-left: 8px;
    }
    .slow-badge.visible { display: inline-block; }

    /* ── Pause overlay ── */
    .paused-badge {
      display: none;
      background: #FFC107;
      color: #1a1a1a;
      font-size: 0.82rem;
      font-weight: 700;
      border-radius: 4px;
      padding: 3px 10px;
      margin-left: 8px;
    }
    .paused-badge.visible { display: inline-block; }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      gap: 10px;
    }

  
    /* ─── Simulation content panel ───────────────────────────────────── */
    .sim-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 8px 24px;
      background: #061520;
      border-radius: 8px;
      color: #ECEFF1;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      overflow-x: auto;
    }

    /* ─── Back button ─────────────────────────────────────────────────── */
    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.42rem 1.1rem;
      margin-bottom: 1.2rem;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 500;
      letter-spacing: 0.03em;
      color: var(--color-primary);
      background: var(--color-primary-light);
      border: 1.5px solid var(--color-primary-medium);
      text-decoration: none;
      transition: background 0.18s, color 0.18s, transform 0.15s,
                  box-shadow 0.18s, border-color 0.18s;
    }
    .btn-back:hover {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
      transform: translateX(-3px);
      box-shadow: 0 4px 16px rgba(26, 79, 100, 0.25);
      text-decoration: none;
    }
    .btn-back-arrow {
      font-size: 0.72rem;
      transition: transform 0.18s;
    }
    .btn-back:hover .btn-back-arrow {
      transform: translateX(-3px);
    }

    /* ── Responsive scaling ─────────────────────────────────── */
    @media (max-width: 700px) {
      .slider-row { grid-template-columns: 1fr auto !important; }
      .slider-row .slider-label,
      .slider-row label { grid-column: 1 / -1; text-align: left !important; }
    }
  </style>
  <script>(function(){var t=localStorage.getItem('theme');if(t)document.documentElement.setAttribute('data-theme',t);})();</script>
</head>
<body id="top">
  <!-- Scroll progress bar -->
  <div class="scroll-progress d-print-none" id="scrollProgress"></div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-nav d-print-none">
    <div class="container">
      <a class="navbar-brand" href="../index.html">Jorge A. Balsells Orellana</a>
      <div class="d-flex align-items-center ms-auto d-lg-none">
        <button class="btn btn-link nav-dark-toggle me-2" id="darkToggleMobile" aria-label="Toggle dark mode">
          <i class="fas fa-moon"></i>
        </button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="../index.html#about">About</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#skills">Skills</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#experience">Experience</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#education">Education</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#certs">Courses</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#projects">Projects</a></li>
          <li class="nav-item"><a class="nav-link" href="../index.html#volunteer">Volunteering</a></li>
          <li class="nav-item"><a class="nav-link" href="../gallery.html">Gallery</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" id="othersDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Others
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="othersDropdown">
              <li><a class="dropdown-item" href="../rope_simulations.html">Rope Simulations</a></li>
            </ul>
          </li>
          <li class="nav-item nav-contact-pill"><a class="nav-link" href="../index.html#contact"><i class="fas fa-envelope me-1"></i>Contact</a></li>
          <li class="nav-item d-none d-lg-block">
            <button class="btn btn-link nav-dark-toggle" id="darkToggleDesktop" aria-label="Toggle dark mode">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="page-content">
    <div class="container">
      <div class="cover shadow-sm">
        <div class="px-3 px-lg-4 py-4">
          <a href="../rope_simulations.html" class="btn-back"><i class="fas fa-chevron-left btn-back-arrow"></i> Rope Simulations</a>
          <h2 class="section-heading"><i class="fas fa-arrow-down"></i>Factor de Caída</h2>
          <div class="sim-content">



<div class="title-row">
  <h1>FACTOR DE CA&Iacute;DA &mdash; Simulaci&oacute;n Animada</h1>
  <span class="slow-badge" id="slowBadge">&#9679; C&Aacute;MARA LENTA &times;0.2</span>
  <span class="paused-badge" id="pausedBadge">&#9646;&#9646; PAUSADO</span>
</div>

<div class="main-layout">

  <!-- ── Left: Animation canvas ── -->
  <canvas id="simCanvas" width="460" height="700"></canvas>

  <!-- ── Right: Info panel ── -->
  <div class="right-panel">

    <!-- Scenario buttons -->
    <div class="scenario-row">
      <button class="btn-scenario" id="btn025" onclick="selectScenario(0.25)">FF 0.25<br><small>Ca&iacute;da corta</small></button>
      <button class="btn-scenario" id="btn050" onclick="selectScenario(0.50)">FF 0.50<br><small>Moderada</small></button>
      <button class="btn-scenario active" id="btn100" onclick="selectScenario(1.0)">FF 1.0<br><small>Nivel anclaje</small></button>
      <button class="btn-scenario" id="btn200" onclick="selectScenario(2.0)">FF 2.0<br><small>Factor m&aacute;ximo</small></button>
    </div>

    <!-- Action buttons -->
    <div class="action-row">
      <button class="btn-action btn-fall" id="btnFall" onclick="startFall()">&#9654; CA&Iacute;DA</button>
      <button class="btn-action btn-reset" onclick="resetSim()">&#10227; Reiniciar</button>
      <button class="btn-action btn-slow" id="btnSlow" onclick="toggleSlow()">&#128016; C&aacute;m. lenta &times;0.2</button>
      <button class="btn-action btn-pause" id="btnPause" onclick="togglePause()">&#9646;&#9646; Pausa</button>
    </div>

    <!-- Semaforo + scenario label -->
    <div class="semaforo-row">
      <div class="semaforo">
        <div class="light red-off"    id="lightRed"></div>
        <div class="light yellow-off" id="lightYellow"></div>
        <div class="light green-off"  id="lightGreen"></div>
      </div>
      <div>
        <div class="info-value primary" id="scenarioLabel">FF 1.0 &mdash; Nivel del anclaje</div>
        <div class="info-value" style="margin-top:4px;" id="semLabel">En espera...</div>
        <div class="info-value" style="font-size:0.8rem;color:#78909C;margin-top:3px;">
          Masa: 100 kg &nbsp;&middot;&nbsp; Cuerda: 2.0 m
        </div>
      </div>
    </div>

    <!-- Physics -->
    <div class="info-label">Factor de Ca&iacute;da</div>
    <div class="info-value primary" id="ffDisplay">FF = d / L = 1.00</div>
    <div class="info-value" style="font-size:0.78rem;color:#78909C;margin-top:2px;">
      FF = distancia_ca&iacute;da / longitud_cuerda &nbsp;&nbsp;|&nbsp;&nbsp; F = m&middot;g&middot;(1 + FF/&epsilon;)
    </div>

    <div class="info-label">Distancia de ca&iacute;da</div>
    <div class="info-value" id="fallDistDisplay">d = 2.00 m</div>

    <hr class="divider">

    <!-- Post-impact results -->
    <div id="resultsBlock" style="display:none;">

      <div class="info-label">Velocidad de impacto</div>
      <div class="info-value info" id="impactSpeed">&mdash;</div>

      <div class="info-label">Distancia de frenado</div>
      <div class="info-value" id="brakeDist" style="font-size:0.82rem;">&mdash;</div>

      <div class="info-label">Aceleraci&oacute;n de frenado</div>
      <div class="info-value" id="decelDisplay">&mdash;</div>

      <div class="info-label">Fuerza de impacto &mdash; Cuerda DIN&Aacute;MICA (&epsilon; = 35%)</div>
      <div class="info-value accent" id="forceDyn">&mdash;</div>

      <div class="info-label">Fuerza de impacto &mdash; Cuerda EST&Aacute;TICA (&epsilon; = 3%)</div>
      <div class="info-value warning" id="forceSta">&mdash;</div>

      <div class="info-label">Fuerzas G</div>
      <div class="info-value" id="gForces">&mdash;</div>

      <hr class="divider">

      <!-- Force bars -->
      <div class="info-label">Barras de fuerza (escala 0 &ndash; 30 kN = MBS)</div>
      <div class="bar-container">
        <div class="bar-bg" id="barDynBg">
          <div class="bar-fill" id="barDyn" style="background:#4CAF50;width:0%;"></div>
          <span class="bar-text" id="barDynTxt">Din: &mdash;</span>
          <!-- markers injected by JS -->
        </div>
        <div class="bar-bg" id="barStaBg">
          <div class="bar-fill" id="barSta" style="background:#FFC107;width:0%;"></div>
          <span class="bar-text" id="barStaTxt">Est: &mdash;</span>
        </div>
      </div>

      <hr class="divider">

    </div><!-- #resultsBlock -->

    <!-- Comparison table (always visible) -->
    <div class="info-label">Comparativa de escenarios</div>
    <table class="comp-table" id="compTable">
      <thead>
        <tr>
          <th>Escenario</th>
          <th>FF</th>
          <th>v (km/h)</th>
          <th>F.din. (kN)</th>
          <th>F.est. (kN)</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="compTbody"></tbody>
    </table>

    <!-- Narrative -->
    <div class="narrative" id="narrative">Elige escenario y pulsa <strong>CA&Iacute;DA</strong> o <kbd>ESPACIO</kbd></div>

  </div><!-- .right-panel -->
</div><!-- .main-layout -->

<!-- Controls bar -->
<div class="controls-bar">
  <div class="ctrl-item"><span class="kbd">ESPACIO</span> Iniciar ca&iacute;da</div>
  <div class="ctrl-item"><span class="kbd">R</span> Reiniciar</div>
  <div class="ctrl-item"><span class="kbd">S</span> C&aacute;mara lenta (solo ca&iacute;da libre)</div>
  <div class="ctrl-item"><span class="kbd">P</span> Pausa</div>
  <div class="ctrl-item"><span class="kbd">1</span> FF 0.25</div>
  <div class="ctrl-item"><span class="kbd">2</span> FF 0.50</div>
  <div class="ctrl-item"><span class="kbd">3</span> FF 1.0</div>
  <div class="ctrl-item"><span class="kbd">4</span> FF 2.0</div>
</div>

<script>
'use strict';

// ── Constants ──────────────────────────────────────────────────────────
const G             = 9.81;
const CLIMBER_MASS  = 100;
const ROPE_LENGTH_M = 2;
const EPS_DYNAMIC   = 0.35;
const EPS_STATIC    = 0.03;
const ROPE_MBS_KN   = 30.0;
const MAX_TRAIL     = 90;
const GRAPH_SECONDS = 5.0;
const SCALE         = 80;   // px per metre (canvas 460px wide, 700px tall)

// ── Colour palette (matches config.py PG_COLORS in hex) ───────────────
const C = {
  bg:        '#061520',
  panel:     '#0a1e2f',
  primary:   '#00BCD4',
  secondary: '#FF5722',
  accent:    '#4CAF50',
  warning:   '#FFC107',
  danger:    '#F44336',
  info:      '#2196F3',
  text:      '#ECEFF1',
  grid:      '#143045',
  rope:      '#FFA726',
  anchor:    '#78909C',
  dark_text: '#b4b4c8',
};

// ── Canvas setup ───────────────────────────────────────────────────────
const canvas = document.getElementById('simCanvas');
const ctx    = canvas.getContext('2d');

// Wall / climber x positions (pixels)
const WALL_X     = 90;
const CLIMBER_X  = WALL_X + 55;

// ── Simulation state ───────────────────────────────────────────────────
let fallFactor    = 1.0;
let scenarioLabel = 'FF 1.0 \u2014 Nivel del anclaje';
let slowMotion    = false;
let paused        = false;

// Physics state
let ropeLen, fallDistance, climberStartM, climberYM, climberEndM;
let anchorPxY;
let velocity, falling, impact, bouncePhase, timeSinceImpact;
let impactSpeedMs, impactForceDynKN, impactForceStaKN;
let gForceDyn, gForceSta, aDecelDyn, aDecelSta, brakeDistDyn, brakeDistSta;
let trail = [];
let tensionKN, tensionHistory = [], simTime;

function resetSim() {
  ropeLen       = ROPE_LENGTH_M;
  fallDistance  = fallFactor * ropeLen;
  climberStartM = ropeLen - fallDistance;
  climberYM     = climberStartM;
  climberEndM   = ropeLen;

  // Anchor pixel Y: keep climber start visible within canvas
  // anchor is at y_m=0, climber start at y_m=climberStartM (negative = above anchor)
  const marginTop = 100;
  anchorPxY = Math.max(180, marginTop + Math.round(-climberStartM * SCALE));

  velocity          = 0;
  falling           = false;
  impact            = false;
  bouncePhase       = 0;
  timeSinceImpact   = 0;

  impactSpeedMs     = 0;
  impactForceDynKN  = 0;
  impactForceStaKN  = 0;
  gForceDyn         = 0;
  gForceSta         = 0;
  aDecelDyn         = 0;
  aDecelSta         = 0;
  brakeDistDyn      = 0;
  brakeDistSta      = 0;

  trail           = [];
  tensionKN       = 0;
  tensionHistory  = [];
  simTime         = 0;

  updateUI();
}

function startFall() {
  resetSim();
  falling  = true;
  velocity = 0;
}

function selectScenario(ff) {
  const labels = {
    0.25: 'FF 0.25 \u2014 Ca\u00edda corta',
    0.5:  'FF 0.50 \u2014 Ca\u00edda moderada',
    1.0:  'FF 1.0  \u2014 Nivel del anclaje',
    2.0:  'FF 2.0  \u2014 Factor m\u00e1ximo',
  };
  fallFactor    = ff;
  scenarioLabel = labels[ff];
  resetSim();
  // Update active button
  document.querySelectorAll('.btn-scenario').forEach(b => b.classList.remove('active'));
  const ids = { 0.25:'btn025', 0.5:'btn050', 1.0:'btn100', 2.0:'btn200' };
  document.getElementById(ids[ff]).classList.add('active');
}

function toggleSlow() {
  slowMotion = !slowMotion;
  document.getElementById('btnSlow').classList.toggle('active', slowMotion);
  document.getElementById('slowBadge').classList.toggle('visible', slowMotion);
}

function togglePause() {
  paused = !paused;
  document.getElementById('btnPause').classList.toggle('active', paused);
  document.getElementById('pausedBadge').classList.toggle('visible', paused);
}

// ── Physics helpers ────────────────────────────────────────────────────

function mToPx(metres) {
  return anchorPxY + metres * SCALE;
}

function computeTension() {
  if (!impact) return 0;
  const t    = timeSinceImpact;
  const mgKN = CLIMBER_MASS * G / 1000;
  const T    = mgKN + (impactForceDynKN - mgKN) * Math.exp(-3 * t) * Math.cos(8 * t);
  return Math.max(0, T);
}

// ── Physics update ─────────────────────────────────────────────────────

function update(dt) {
  if (paused) return;

  // Slow motion only during free-fall, not post-impact
  const effDt = (slowMotion && falling && !impact) ? dt * 0.2 : dt;

  simTime    += effDt;
  tensionKN   = computeTension();

  tensionHistory.push([simTime, tensionKN]);
  const cutoff = simTime - GRAPH_SECONDS;
  while (tensionHistory.length && tensionHistory[0][0] < cutoff) {
    tensionHistory.shift();
  }

  if (!falling || impact) {
    if (impact) {
      timeSinceImpact += effDt;
      bouncePhase     += effDt * 8;
      const damping    = Math.exp(-timeSinceImpact * 3);
      const bounce     = damping * Math.sin(bouncePhase) * 0.3;
      climberYM        = climberEndM + bounce;
    }
    return;
  }

  // Free fall
  velocity  += G * effDt;
  climberYM += velocity * effDt;

  // Trail
  const yPx = mToPx(climberYM);
  trail.push([CLIMBER_X, Math.round(yPx)]);
  if (trail.length > MAX_TRAIL) trail.shift();

  // Impact detection
  if (climberYM >= climberEndM) {
    climberYM = climberEndM;
    impact    = true;

    impactSpeedMs   = Math.sqrt(2 * G * fallDistance);
    brakeDistDyn    = EPS_DYNAMIC * ropeLen;
    brakeDistSta    = EPS_STATIC  * ropeLen;
    aDecelDyn       = G * fallFactor / EPS_DYNAMIC;
    aDecelSta       = G * fallFactor / EPS_STATIC;
    impactForceDynKN = CLIMBER_MASS * G * (1 + fallFactor / EPS_DYNAMIC) / 1000;
    impactForceStaKN = CLIMBER_MASS * G * (1 + fallFactor / EPS_STATIC)  / 1000;
    gForceDyn        = impactForceDynKN * 1000 / (CLIMBER_MASS * G);
    gForceSta        = impactForceStaKN * 1000 / (CLIMBER_MASS * G);

    updateUI();
  }
}

// ── Tension graph (drawn on canvas, bottom-left area) ─────────────────

function drawTensionGraph() {
  const gx = 8, gy = 420;
  const gw = 444, gh = 265;
  const padL = 52, padR = 14, padT = 22, padB = 30;

  // Semi-transparent background
  ctx.save();
  ctx.globalAlpha = 0.88;
  ctx.fillStyle   = 'rgba(10,10,25,0.88)';
  ctx.strokeStyle = C.grid;
  ctx.lineWidth   = 1;
  roundRect(ctx, gx, gy, gw, gh, 6);
  ctx.fill();
  ctx.stroke();
  ctx.globalAlpha = 1;

  // Title
  ctx.fillStyle = C.primary;
  ctx.font      = '11px "Segoe UI", system-ui, sans-serif';
  ctx.fillText('Tensi\u00f3n de la cuerda (kN) \u2014 tiempo real', gx + padL, gy + 15);

  const px0 = gx + padL;
  const px1 = gx + gw - padR;
  const py0 = gy + padT;
  const py1 = gy + gh - padB;
  const pw  = px1 - px0;
  const ph  = py1 - py0;

  const mgKN  = CLIMBER_MASS * G / 1000;
  const peakKN = impact ? impactForceDynKN : 0;
  const maxY   = Math.max(peakKN * 1.15, mgKN * 2.5, 3.0);

  function toScreen(tVal, knVal) {
    if (!tensionHistory.length) return [px0, py1];
    const tMin   = tensionHistory[0][0];
    const tMax   = tensionHistory[tensionHistory.length - 1][0];
    const tSpan  = Math.max(tMax - tMin, 1e-3);
    const sx     = px0 + (tVal - tMin) / tSpan * pw;
    const sy     = py1 - (knVal / maxY) * ph;
    return [sx, sy];
  }

  // Horizontal grid lines
  const refs = [0, mgKN, 6.0, 9.0, 12.0];
  ctx.font = '10px "Segoe UI", system-ui, sans-serif';
  for (const knRef of refs) {
    if (knRef > maxY) continue;
    const sy = py1 - (knRef / maxY) * ph;
    ctx.strokeStyle = knRef === 12.0 ? C.danger : (Math.abs(knRef - mgKN) < 0.05 ? C.accent : C.grid);
    ctx.lineWidth   = 1;
    ctx.setLineDash(knRef === 12.0 ? [4, 3] : []);
    ctx.beginPath();
    ctx.moveTo(px0, sy);
    ctx.lineTo(px1, sy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = knRef === 12.0 ? C.danger : C.anchor;
    ctx.fillText(knRef.toFixed(1), gx + 2, sy + 4);
  }

  // Special labels
  const mgSy = py1 - (mgKN / maxY) * ph;
  ctx.fillStyle = C.accent;
  ctx.fillText('mg=' + mgKN.toFixed(2), px1 - 58, mgSy - 4);
  if (maxY >= 12.0) {
    const uiaaSy = py1 - (12.0 / maxY) * ph;
    ctx.fillStyle = C.danger;
    ctx.fillText('UIAA 12kN', px1 - 68, uiaaSy - 4);
  }

  // Plot area border
  ctx.strokeStyle = C.grid;
  ctx.lineWidth   = 1;
  ctx.strokeRect(px0, py0, pw, ph);

  // Tension curve
  if (tensionHistory.length >= 2) {
    for (let i = 0; i < tensionHistory.length - 1; i++) {
      const [t0, k0] = tensionHistory[i];
      const [t1, k1] = tensionHistory[i + 1];
      const [sx0, sy0] = toScreen(t0, k0);
      const [sx1, sy1] = toScreen(t1, k1);
      ctx.strokeStyle = k1 < 6 ? C.accent : (k1 < 9 ? C.warning : C.danger);
      ctx.lineWidth   = 2;
      ctx.beginPath();
      ctx.moveTo(sx0, Math.max(py0, Math.min(py1, sy0)));
      ctx.lineTo(sx1, Math.max(py0, Math.min(py1, sy1)));
      ctx.stroke();
    }
  }

  // Current point + value
  if (tensionHistory.length) {
    const [lastT, lastKN] = tensionHistory[tensionHistory.length - 1];
    const [sx, syRaw]     = toScreen(lastT, lastKN);
    const sy = Math.max(py0, Math.min(py1, syRaw));
    const dotCol = lastKN < 6 ? C.accent : (lastKN < 9 ? C.warning : C.danger);
    ctx.fillStyle = dotCol;
    ctx.beginPath();
    ctx.arc(sx, sy, 5, 0, Math.PI * 2);
    ctx.fill();
    ctx.font      = '10px "Segoe UI", system-ui, sans-serif';
    ctx.fillStyle = dotCol;
    const valStr  = lastKN.toFixed(2) + ' kN';
    const labelX  = Math.min(sx + 6, px1 - 50);
    const labelY  = Math.max(py0 + 2, sy - 16);
    ctx.fillText(valStr, labelX, labelY);
  }

  // Peak indicator
  if (impact) {
    const peakSyRaw = py1 - (Math.min(impactForceDynKN, maxY) / maxY) * ph;
    const peakSy    = Math.max(py0, peakSyRaw);
    ctx.strokeStyle = 'rgba(180,180,210,0.55)';
    ctx.lineWidth   = 1;
    ctx.setLineDash([3, 4]);
    ctx.beginPath();
    ctx.moveTo(px0, peakSy);
    ctx.lineTo(px1, peakSy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(190,190,220,0.9)';
    ctx.font      = '10px "Segoe UI", system-ui, sans-serif';
    ctx.fillText('pico ' + impactForceDynKN.toFixed(2) + ' kN', px0 + 4, peakSy - 3);
  }

  // X axis label
  ctx.fillStyle = C.dark_text;
  ctx.font      = '10px "Segoe UI", system-ui, sans-serif';
  ctx.fillText('\u00faltimos ' + GRAPH_SECONDS.toFixed(0) + ' s  \u2192', px0 + pw / 2 - 32, py1 + 18);

  ctx.restore();
}

// ── Canvas draw ────────────────────────────────────────────────────────

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = C.bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const climberPxY = mToPx(climberYM);
  const anchorPx   = [WALL_X, Math.round(mToPx(0))];

  // ── Wall ──────────────────────────────────────────────────────────
  const wallTop = Math.max(40, anchorPxY - 130);
  ctx.fillStyle = '#28283c';
  ctx.fillRect(WALL_X - 34, wallTop, 34, canvas.height - wallTop - 30);
  ctx.strokeStyle = '#383858';
  ctx.lineWidth   = 1;
  for (let wy = wallTop; wy < canvas.height - 30; wy += 20) {
    ctx.beginPath();
    ctx.moveTo(WALL_X - 34, wy);
    ctx.lineTo(WALL_X, wy);
    ctx.stroke();
  }
  // Hatching diagonal lines
  ctx.strokeStyle = 'rgba(80,80,120,0.35)';
  ctx.lineWidth   = 1;
  for (let wy = wallTop; wy < canvas.height - 30; wy += 14) {
    ctx.beginPath();
    ctx.moveTo(WALL_X - 34, wy);
    ctx.lineTo(Math.min(WALL_X, WALL_X - 34 + 14), wy + 14);
    ctx.stroke();
  }

  // ── Anchor ────────────────────────────────────────────────────────
  ctx.fillStyle   = C.anchor;
  ctx.strokeStyle = C.anchor;
  ctx.beginPath();
  ctx.arc(anchorPx[0], anchorPx[1], 12, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = C.warning;
  ctx.beginPath();
  ctx.arc(anchorPx[0], anchorPx[1], 6, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = C.anchor;
  ctx.font      = '11px "Segoe UI", system-ui, sans-serif';
  ctx.fillText('ANCLAJE', anchorPx[0] - 60, anchorPx[1] - 18);

  // ── Trail ─────────────────────────────────────────────────────────
  const n = trail.length;
  const ropeRGB = [255, 167, 38];
  const dimRGB  = [50, 30, 8];
  for (let i = 0; i < n; i++) {
    const ratio = i / Math.max(n - 1, 1);
    const r = Math.round(dimRGB[0] + ratio * (ropeRGB[0] - dimRGB[0]));
    const g2= Math.round(dimRGB[1] + ratio * (ropeRGB[1] - dimRGB[1]));
    const b = Math.round(dimRGB[2] + ratio * (ropeRGB[2] - dimRGB[2]));
    ctx.fillStyle = `rgb(${r},${g2},${b})`;
    const radius  = Math.max(1, Math.round(ratio * 3));
    ctx.beginPath();
    ctx.arc(trail[i][0], trail[i][1], radius, 0, Math.PI * 2);
    ctx.fill();
  }

  // ── Rope ──────────────────────────────────────────────────────────
  let ropeColor = C.rope;
  if (impact) {
    const intensity = Math.min(impactForceDynKN / 15.0, 1.0);
    const r = Math.round(255 * intensity + 255 * (1 - intensity) * 0.65);
    const g2= Math.round(167 * (1 - intensity));
    const b = Math.round(38  * (1 - intensity));
    ropeColor = `rgb(${r},${g2},${b})`;
  }
  ctx.strokeStyle = ropeColor;
  ctx.lineWidth   = 3;
  ctx.lineJoin    = 'round';
  ctx.beginPath();
  if (!impact && climberYM < climberEndM * 0.9) {
    // Slack rope: two-segment curve
    const midX = WALL_X + 25;
    const midY = (anchorPx[1] + climberPxY) / 2 + 22;
    ctx.moveTo(anchorPx[0], anchorPx[1]);
    ctx.lineTo(midX, midY);
    ctx.lineTo(CLIMBER_X, Math.round(climberPxY));
  } else {
    ctx.moveTo(anchorPx[0], anchorPx[1]);
    ctx.lineTo(CLIMBER_X, Math.round(climberPxY));
  }
  ctx.stroke();

  // ── Velocity label ────────────────────────────────────────────────
  if (falling && !impact && velocity > 0.5) {
    ctx.fillStyle = C.danger;
    ctx.font      = 'bold 11px "Segoe UI", system-ui, sans-serif';
    ctx.fillText(
      '\u2193 ' + velocity.toFixed(1) + ' m/s  (' + (velocity * 3.6).toFixed(0) + ' km/h)',
      CLIMBER_X + 24, Math.round(climberPxY) - 10
    );
  }

  // ── Climber figure ────────────────────────────────────────────────
  const climberColor = impact ? C.warning : C.primary;
  const cpx = CLIMBER_X;
  const cpy = Math.round(climberPxY);
  const headY = cpy - 28;
  // Head
  ctx.fillStyle   = climberColor;
  ctx.strokeStyle = climberColor;
  ctx.lineWidth   = 2;
  ctx.beginPath();
  ctx.arc(cpx, headY, 10, 0, Math.PI * 2);
  ctx.fill();
  // Torso
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(cpx, headY + 10);
  ctx.lineTo(cpx, cpy + 12);
  ctx.stroke();
  // Arms
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cpx - 16, cpy - 6);
  ctx.lineTo(cpx + 16, cpy - 6);
  ctx.stroke();
  // Legs
  ctx.beginPath();
  ctx.moveTo(cpx, cpy + 12);
  ctx.lineTo(cpx - 12, cpy + 34);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cpx, cpy + 12);
  ctx.lineTo(cpx + 12, cpy + 34);
  ctx.stroke();

  // ── Distance markers ──────────────────────────────────────────────
  const startPxY = mToPx(climberStartM);
  const endPxY   = mToPx(climberEndM);

  // Start marker (green)
  ctx.strokeStyle = C.accent;
  ctx.lineWidth   = 1.5;
  ctx.beginPath();
  ctx.moveTo(WALL_X + 32, startPxY);
  ctx.lineTo(WALL_X + 75, startPxY);
  ctx.stroke();
  ctx.fillStyle = C.accent;
  ctx.font      = '11px "Segoe UI", system-ui, sans-serif';
  ctx.fillText('Inicio', WALL_X + 78, startPxY + 4);

  // End marker (red)
  ctx.strokeStyle = C.danger;
  ctx.lineWidth   = 1.5;
  ctx.beginPath();
  ctx.moveTo(WALL_X + 32, endPxY);
  ctx.lineTo(WALL_X + 75, endPxY);
  ctx.stroke();
  ctx.fillStyle = C.danger;
  ctx.fillText('Fin ca\u00edda', WALL_X + 78, endPxY + 4);

  // Arrow showing fall distance
  if (Math.abs(endPxY - startPxY) > 24) {
    const ax = WALL_X + 110;
    ctx.strokeStyle = C.warning;
    ctx.lineWidth   = 2;
    ctx.beginPath();
    ctx.moveTo(ax, startPxY);
    ctx.lineTo(ax, endPxY);
    ctx.stroke();
    // Arrowheads
    ctx.fillStyle = C.warning;
    ctx.beginPath();
    ctx.moveTo(ax, startPxY);
    ctx.lineTo(ax - 5, startPxY + 12);
    ctx.lineTo(ax + 5, startPxY + 12);
    ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(ax, endPxY);
    ctx.lineTo(ax - 5, endPxY - 12);
    ctx.lineTo(ax + 5, endPxY - 12);
    ctx.closePath();
    ctx.fill();
    ctx.fillStyle = C.warning;
    ctx.font      = 'bold 11px "Segoe UI", system-ui, sans-serif';
    ctx.fillText('d = ' + fallDistance.toFixed(1) + ' m', ax + 8, (startPxY + endPxY) / 2 + 4);
  }

  // Rope length indicator (left of wall)
  const ropeAx   = WALL_X - 50;
  const anchorY0 = mToPx(0);
  ctx.strokeStyle = C.info;
  ctx.lineWidth   = 2;
  ctx.beginPath();
  ctx.moveTo(ropeAx, anchorY0);
  ctx.lineTo(ropeAx, endPxY);
  ctx.stroke();
  ctx.fillStyle = C.info;
  ctx.font      = '11px "Segoe UI", system-ui, sans-serif';
  ctx.fillText('L = ' + ropeLen.toFixed(1) + ' m', ropeAx - 54, (anchorY0 + endPxY) / 2 + 4);

  // ── Tension graph (bottom-left, semi-transparent) ─────────────────
  drawTensionGraph();
}

// ── Utility: rounded rectangle path ───────────────────────────────────
function roundRect(context, x, y, w, h, r) {
  context.beginPath();
  context.moveTo(x + r, y);
  context.lineTo(x + w - r, y);
  context.quadraticCurveTo(x + w, y, x + w, y + r);
  context.lineTo(x + w, y + h - r);
  context.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  context.lineTo(x + r, y + h);
  context.quadraticCurveTo(x, y + h, x, y + h - r);
  context.lineTo(x, y + r);
  context.quadraticCurveTo(x, y, x + r, y);
  context.closePath();
}

// ── UI updates (DOM panel) ─────────────────────────────────────────────

function semState() {
  if (!impact) return null;
  if (impactForceDynKN < 6.0) return 'green';
  if (impactForceDynKN < 9.0) return 'yellow';
  return 'red';
}

function narrativeText() {
  if (!falling && !impact)
    return 'Elige escenario y pulsa <strong>CA\u00cdDA</strong> o <kbd>ESPACIO</kbd>';
  if (falling && !impact) {
    if (velocity < 2.0) return 'Ca\u00edda libre... \u2193 comenzando';
    return 'Ca\u00edda libre \u2193 ' + velocity.toFixed(1) + ' m/s \u2014 \u00a1acelerando!';
  }
  if (timeSinceImpact < 0.5) return '\u00a1CUERDA TENSA! \u2014 absorbiendo el impacto...';
  return 'Impacto absorbido \u2014 oscilando';
}

function narrativeColor() {
  if (!falling && !impact)   return C.warning;
  if (falling && !impact)    return velocity < 2 ? C.rope : C.danger;
  if (timeSinceImpact < 0.5) return C.danger;
  return C.warning;
}

function buildCompTable() {
  const rows = [
    { ff: 0.25, lbl: 'Ca\u00edda corta' },
    { ff: 0.5,  lbl: 'Moderada'     },
    { ff: 1.0,  lbl: 'Nivel anclaje' },
    { ff: 2.0,  lbl: 'Factor m\u00e1x.' },
  ];
  const tbody = document.getElementById('compTbody');
  tbody.innerHTML = '';
  for (const row of rows) {
    const fd    = ROPE_LENGTH_M * row.ff;
    const vKmh  = Math.sqrt(2 * G * fd) * 3.6;
    const fDyn  = CLIMBER_MASS * G * (1 + row.ff / EPS_DYNAMIC) / 1000;
    const fSta  = CLIMBER_MASS * G * (1 + row.ff / EPS_STATIC)  / 1000;
    const isCur = Math.abs(row.ff - fallFactor) < 0.01;

    let estado, cSta;
    if (fSta > ROPE_MBS_KN)  { estado = 'ROMPE'; cSta = C.danger; }
    else if (fSta > 12.0)     { estado = 'UIAA!'; cSta = C.danger; }
    else                      { estado = 'OK';    cSta = C.accent; }

    const cDyn = fDyn < 6 ? C.accent : (fDyn < 9 ? C.warning : C.danger);
    const cRow = isCur ? C.warning : '#b0bec5';
    const prefix = isCur ? '\u2192 ' : '\u00a0\u00a0';

    const tr = document.createElement('tr');
    if (isCur) tr.className = 'active-row';
    tr.innerHTML = `
      <td style="color:${cRow}">${prefix}FF ${row.ff.toFixed(2)} ${row.lbl}</td>
      <td style="color:${cRow}">${row.ff.toFixed(2)}</td>
      <td style="color:${cRow}">${vKmh.toFixed(1)}</td>
      <td style="color:${cDyn}">${fDyn.toFixed(2)}</td>
      <td style="color:${cSta}">${fSta.toFixed(2)}</td>
      <td style="color:${estado !== 'OK' ? C.danger : C.accent}">${estado}</td>
    `;
    tbody.appendChild(tr);
  }
}

function updateUI() {
  // Scenario label
  document.getElementById('scenarioLabel').textContent = scenarioLabel;

  // FF display
  const ffCol = fallFactor < 0.5 ? C.accent : (fallFactor < 1.5 ? C.warning : C.danger);
  const ffEl  = document.getElementById('ffDisplay');
  ffEl.textContent = 'FF = d / L = ' + fallFactor.toFixed(2);
  ffEl.style.color = ffCol;

  // Fall distance
  document.getElementById('fallDistDisplay').textContent =
    'd = ' + fallDistance.toFixed(2) + ' m   (L = ' + ropeLen.toFixed(1) + ' m)';

  // Semaforo
  const state = semState();
  document.getElementById('lightRed').className    = 'light ' + (state === 'red'    ? 'red-on'    : 'red-off');
  document.getElementById('lightYellow').className = 'light ' + (state === 'yellow' ? 'yellow-on' : 'yellow-off');
  document.getElementById('lightGreen').className  = 'light ' + (state === 'green'  ? 'green-on'  : 'green-off');

  const semLabels = {
    green:  { txt: 'SEGURO',      col: C.accent  },
    yellow: { txt: 'PRECAUCI\u00d3N', col: C.warning },
    red:    { txt: 'PELIGROSO',   col: C.danger  },
    null:   { txt: 'En espera...', col: C.anchor  },
  };
  const sl = semLabels[state] || semLabels['null'];
  const semLabelEl = document.getElementById('semLabel');
  semLabelEl.textContent = sl.txt;
  semLabelEl.style.color = sl.col;
  semLabelEl.style.fontWeight = '700';

  // Results block
  const rb = document.getElementById('resultsBlock');
  if (impact) {
    rb.style.display = 'block';
    const velKmh = impactSpeedMs * 3.6;
    document.getElementById('impactSpeed').textContent =
      impactSpeedMs.toFixed(2) + ' m/s  (' + velKmh.toFixed(1) + ' km/h)';

    document.getElementById('brakeDist').textContent =
      'Din. ' + (brakeDistDyn * 100).toFixed(1) + ' cm   |   Est. ' + (brakeDistSta * 100).toFixed(1) + ' cm   (= \u03b5\u00b7L)';

    const aCol = aDecelDyn < 30 ? C.accent : (aDecelDyn < 80 ? C.warning : C.danger);
    const decEl = document.getElementById('decelDisplay');
    decEl.textContent =
      'Din. ' + aDecelDyn.toFixed(1) + ' m/s\u00b2 (' + (aDecelDyn / G).toFixed(1) + ' g)'
      + '   |   Est. ' + aDecelSta.toFixed(1) + ' m/s\u00b2 (' + (aDecelSta / G).toFixed(1) + ' g)';
    decEl.style.color = aCol;

    const equivKgDyn = impactForceDynKN * 1000 / G;
    document.getElementById('forceDyn').textContent =
      impactForceDynKN.toFixed(2) + ' kN  (' + equivKgDyn.toFixed(0) + ' kg equiv.)';

    const fSta = impactForceStaKN;
    const staEl = document.getElementById('forceSta');
    if (fSta > ROPE_MBS_KN) {
      staEl.textContent = fSta.toFixed(2) + ' kN  \u2190 SUPERA MBS (' + ROPE_MBS_KN.toFixed(0) + ' kN) \u2014 LA CUERDA CEDERR\u00cdA';
      staEl.style.color = C.danger;
    } else {
      const equivKgSta = fSta * 1000 / G;
      staEl.textContent = fSta.toFixed(2) + ' kN  (' + equivKgSta.toFixed(0) + ' kg equiv.)';
      staEl.style.color = fSta > 12 ? C.danger : C.warning;
    }

    const gCol = gForceDyn < 5 ? C.accent : (gForceDyn < 10 ? C.warning : C.danger);
    const gEl  = document.getElementById('gForces');
    gEl.textContent = 'Din. ' + gForceDyn.toFixed(1) + ' g   |  Est. ' + gForceSta.toFixed(1) + ' g   [lesi\u00f3n grave > ~20 g]';
    gEl.style.color = gCol;

    // Force bars
    const ratioDyn = Math.min(impactForceDynKN / ROPE_MBS_KN, 1.0);
    const ratioSta = Math.min(fSta / ROPE_MBS_KN, 1.0);
    const barDynEl = document.getElementById('barDyn');
    barDynEl.style.width = (ratioDyn * 100).toFixed(1) + '%';
    barDynEl.style.background = impactForceDynKN < 6 ? C.accent : (impactForceDynKN < 9 ? C.warning : C.danger);
    document.getElementById('barDynTxt').textContent = 'Din: ' + impactForceDynKN.toFixed(2) + ' kN';

    const barStaEl = document.getElementById('barSta');
    barStaEl.style.width = (ratioSta * 100).toFixed(1) + '%';
    barStaEl.style.background = fSta > 12 ? C.danger : C.warning;
    document.getElementById('barStaTxt').textContent =
      'Est: ' + fSta.toFixed(2) + ' kN' + (fSta > ROPE_MBS_KN ? '  \u2190 EXCEDE MBS' : '');

    // Inject bar reference markers (UIAA 12 kN + MBS 30 kN)
    for (const bgId of ['barDynBg', 'barStaBg']) {
      const bgEl = document.getElementById(bgId);
      // Remove old markers
      bgEl.querySelectorAll('.bar-marker, .bar-marker-label').forEach(el => el.remove());
      for (const [knRef, label, col] of [[12.0, 'UIAA 12kN', C.danger], [ROPE_MBS_KN, 'MBS 30kN', '#b43c3c']]) {
        const pct = (knRef / ROPE_MBS_KN) * 100;
        const mk  = document.createElement('div');
        mk.className   = 'bar-marker';
        mk.style.cssText = `left:${pct}%;background:${col};`;
        bgEl.appendChild(mk);
        const lbl = document.createElement('div');
        lbl.className  = 'bar-marker-label';
        lbl.style.cssText = `left:${pct}%;color:${col};`;
        lbl.textContent = label;
        bgEl.appendChild(lbl);
      }
    }
  } else {
    rb.style.display = 'none';
  }

  buildCompTable();
}

function updateNarrative() {
  const el = document.getElementById('narrative');
  el.innerHTML = narrativeText();
  el.style.color = narrativeColor();
}

// ── Animation loop ─────────────────────────────────────────────────────

let lastTime = null;

function loop(timestamp) {
  if (lastTime === null) lastTime = timestamp;
  const dt = Math.min((timestamp - lastTime) / 1000, 0.05); // cap at 50 ms
  lastTime = timestamp;

  update(dt);
  draw();
  updateNarrative();

  requestAnimationFrame(loop);
}

// ── Keyboard controls ──────────────────────────────────────────────────

document.addEventListener('keydown', e => {
  // Ignore if typing in an input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  if (e.code === 'Space') {
    e.preventDefault();
    if (!paused) startFall();
  } else if (e.code === 'KeyR') {
    resetSim();
  } else if (e.code === 'KeyS') {
    toggleSlow();
  } else if (e.code === 'KeyP') {
    togglePause();
  } else if (e.code === 'Digit1') {
    selectScenario(0.25);
  } else if (e.code === 'Digit2') {
    selectScenario(0.50);
  } else if (e.code === 'Digit3') {
    selectScenario(1.0);
  } else if (e.code === 'Digit4') {
    selectScenario(2.0);
  }
});

// ── Bootstrap ─────────────────────────────────────────────────────────
selectScenario(1.0);
requestAnimationFrame(loop);
</script>

          </div><!-- /.sim-content -->
        </div>
      </div><!-- /.cover -->
    </div><!-- /.container -->
  </div><!-- /.page-content -->

  <footer class="site-footer d-print-none">
    <div class="container text-center">
      <p>&copy; <span id="footer-year"></span> Jorge A. Balsells Orellana. All rights reserved.</p>
    </div>
  </footer>

  <button class="back-to-top d-print-none" id="backToTop" aria-label="Back to top">
    <i class="fas fa-chevron-up"></i>
  </button>

  <script>
/* ── Responsive canvas scaling ─────────────────────────────── */
(function () {
  var s = document.querySelector('.canvas-row, .main-layout, .main-row');
  if (!s) return;
  function init() {
    var _saved = s.style.minWidth;
    s.style.minWidth = 'max-content';
    var nW = s.offsetWidth, nH = s.offsetHeight;
    s.style.minWidth = _saved;
    if (!nW) return;
    var w = document.createElement('div');
    w.style.cssText = 'width:100%;overflow:hidden;';
    s.parentNode.insertBefore(w, s);
    w.appendChild(s);
    function rescale() {
      var a = w.clientWidth;
      if (a > 0 && a < nW) {
        var sc = a / nW;
        s.style.transformOrigin = 'top left';
        s.style.transform = 'scale(' + sc + ')';
        w.style.height = Math.ceil(nH * sc) + 'px';
      } else {
        s.style.transform = '';
        w.style.height = '';
      }
    }
    window.addEventListener('resize', rescale);
    rescale();
  }
  if (document.readyState === 'complete') { init(); }
  else { window.addEventListener('load', init); }
})();
</script>
<script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../scripts/aos.js"></script>
  <script src="../scripts/main.js"></script>

</body>
</html>
